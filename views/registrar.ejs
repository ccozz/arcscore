<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registrar Partido</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <%- include('partials/navbar') %>

  <main class="container mt-5">
    <div class="card shadow-sm p-4">
      <h1 class="mb-4 text-center fs-4 fs-md-2">Registrar Partido</h1>

      <form action="/registrar" method="POST">
        <!-- FECHA -->
        <div class="mb-4">
          <h4 class="fs-6 fs-md-4">Fecha del partido (miércoles)</h4>
          <input type="date" class="form-control form-control-sm" name="fecha" id="fechaPartido" required>
          <div class="form-text text-danger" id="errorFecha" style="display: none;">
            Solo se pueden seleccionar días miércoles.
          </div>
        </div>

        <div class="row">
          <!-- EQUIPO A -->
          <div class="col-md-6">
            <h4 class="fs-6 fs-md-4">Equipo A</h4>
            <% for (let i = 0; i < 5; i++) { %>
              <div class="mb-2">
                <select class="form-select form-select-sm jugador-select" name="equipoA[]" required>
                  <option value="">Seleccionar jugador</option>
                  <% jugadores.forEach(j => { %>
                    <option value="<%= j.nombre %>"><%= j.nombre %></option>
                  <% }) %>
                  <option value="__nuevo__">➕ Agregar nuevo jugador</option>
                </select>
              </div>
            <% } %>
          </div>

          <!-- EQUIPO B -->
          <div class="col-md-6">
            <h4 class="fs-6 fs-md-4">Equipo B</h4>
            <% for (let i = 0; i < 5; i++) { %>
              <div class="mb-2">
                <select class="form-select form-select-sm jugador-select" name="equipoB[]" required>
                  <option value="">Seleccionar jugador</option>
                  <% jugadores.forEach(j => { %>
                    <option value="<%= j.nombre %>"><%= j.nombre %></option>
                  <% }) %>
                  <option value="__nuevo__">➕ Agregar nuevo jugador</option>
                </select>
              </div>
            <% } %>
          </div>
        </div>

        <!-- GOL DE PECHERA -->
        <div class="mt-4">
          <h4 class="fs-6 fs-md-4">Gol de pechera</h4>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="pechera" value="A" required>
            <label class="form-check-label">Equipo A</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="pechera" value="B" required>
            <label class="form-check-label">Equipo B</label>
          </div>
        </div>

        <!-- GANADOR -->
        <div class="mt-4">
          <h4 class="fs-6 fs-md-4">Resultado del partido</h4>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="ganador" value="A" required>
            <label class="form-check-label">Ganó equipo A</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="ganador" value="B" required>
            <label class="form-check-label">Ganó equipo B</label>
          </div>
        </div>

        <!-- BAJAS -->
        <div class="mt-4">
          <h4 class="fs-6 fs-md-4">Jugadores que se bajaron</h4>
          <div id="bajasContainer" class="mb-2"></div>
          <div class="input-group">
            <select id="bajaSelect" class="form-select form-select-sm">
              <option value="">Seleccionar jugador</option>
              <% jugadores.forEach(j => { %>
                <option value="<%= j.nombre %>"><%= j.nombre %></option>
              <% }) %>
            </select>
            <button type="button" class="btn btn-outline-secondary" onclick="agregarJugador('baja')">+</button>
          </div>
          <input type="hidden" name="bajas" id="bajasInput">
        </div>

        <!-- SUPLENTES -->
        <div class="mt-4">
          <h4 class="fs-6 fs-md-4">Suplentes que ingresaron</h4>
          <div id="suplentesContainer" class="mb-2"></div>
          <div class="input-group">
            <select id="suplenteSelect" class="form-select form-select-sm">
              <option value="">Seleccionar jugador</option>
              <% jugadores.forEach(j => { %>
                <option value="<%= j.nombre %>"><%= j.nombre %></option>
              <% }) %>
            </select>
            <button type="button" class="btn btn-outline-secondary" onclick="agregarJugador('suplente')">+</button>
          </div>
          <input type="hidden" name="suplentes" id="suplentesInput">
        </div>

        <input type="hidden" name="nuevoJugador" id="nuevoJugadorHidden">

        <!-- BOTÓN SUBMIT -->
        <div class="mt-5 mb-5 text-center">
          <button type="submit" class="btn btn-primary btn-lg w-100 w-md-auto">Registrar Partido</button>
        </div>
      </form>
    </div>
  </main>

  <!-- MODAL NUEVO JUGADOR -->
  <div class="modal fade" id="modalNuevoJugador" tabindex="-1" aria-labelledby="modalNuevoJugadorLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title">Agregar nuevo jugador</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="text" class="form-control" id="inputNuevoJugador" placeholder="Nombre del jugador">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarNuevoJugador">Agregar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DARK MODE -->
  <script>
    const root = document.documentElement;
    const modoGuardado = localStorage.getItem('modo');
    if (modoGuardado === 'claro') {
      root.classList.remove('dark-mode');
    } else {
      root.classList.add('dark-mode');
    }
  </script>

  <!-- VALIDACIÓN FECHA -->
  <script>
    const inputFecha = document.getElementById('fechaPartido');
    const errorFecha = document.getElementById('errorFecha');
    const form = document.querySelector('form');

    function esMiercoles(fechaStr) {
      const partes = fechaStr.split("-");
      if (partes.length !== 3) return false;
      const fecha = new Date(+partes[0], partes[1] - 1, +partes[2]);
      return fecha.getDay() === 3;
    }

    inputFecha.addEventListener('change', () => {
      const esValida = esMiercoles(inputFecha.value);
      inputFecha.setCustomValidity(esValida ? '' : 'Solo se permiten miércoles');
      errorFecha.style.display = esValida ? 'none' : 'block';
    });

    form.addEventListener('submit', (e) => {
      const esValida = esMiercoles(inputFecha.value);
      if (!esValida) {
        e.preventDefault();
        inputFecha.setCustomValidity('Solo se permiten miércoles');
        inputFecha.reportValidity();
        errorFecha.style.display = 'block';
      } else {
        inputFecha.setCustomValidity('');
        errorFecha.style.display = 'none';
      }
    });
  </script>

  <!-- JUGADORES ÚNICOS Y MODAL -->
  <script>
    const selects = document.querySelectorAll('.jugador-select');
    function jugadoresElegidos(exclude = null) {
      const nombres = [];
      selects.forEach(s => {
        if (s !== exclude && s.value && s.value !== "__nuevo__") nombres.push(s.value);
      });
      return nombres;
    }

    let selectActivo = null;
    selects.forEach(select => {
      select.addEventListener('change', e => {
        if (e.target.value === '__nuevo__') {
          selectActivo = e.target;
          document.getElementById('inputNuevoJugador').value = '';
          new bootstrap.Modal(document.getElementById('modalNuevoJugador')).show();
        } else {
          if (jugadoresElegidos(select).includes(select.value)) {
            alert("Ese jugador ya fue elegido.");
            select.value = "";
          }
        }
      });
    });

    document.getElementById('btnConfirmarNuevoJugador').addEventListener('click', () => {
      const nuevoNombre = document.getElementById('inputNuevoJugador').value.trim();
      if (!nuevoNombre || !selectActivo) return;

      const existe = Array.from(selectActivo.options).some(opt => opt.value === nuevoNombre);
      if (!existe) {
        const option = document.createElement('option');
        option.value = nuevoNombre;
        option.textContent = nuevoNombre;
        option.selected = true;
        selectActivo.appendChild(option);
      } else {
        selectActivo.value = nuevoNombre;
      }
      document.getElementById('nuevoJugadorHidden').value = nuevoNombre;
      bootstrap.Modal.getInstance(document.getElementById('modalNuevoJugador')).hide();
    });
  </script>

  <!-- BAJAS Y SUPLENTES -->
  <script>
    const listas = { baja: [], suplente: [] };
    function agregarJugador(tipo) {
      const select = document.getElementById(tipo + 'Select');
      const nombre = select.value;
      if (!nombre || listas[tipo].includes(nombre)) return;

      listas[tipo].push(nombre);
      const container = document.getElementById(tipo + 'sContainer');
      const badge = document.createElement('span');
      badge.classList.add('badge', 'bg-secondary', 'me-1', 'mb-1');
      badge.textContent = nombre;
      container.appendChild(badge);
      document.getElementById(tipo + 'sInput').value = listas[tipo].join(',');
      select.value = '';
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>